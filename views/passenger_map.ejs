<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Booking - Confirm Your Ride</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body, html { height: 100%; width: 100%; overflow: hidden; }
        
        #map { height: 65%; width: 100%; }

        .back-btn {
            position: absolute; top: 15px; left: 15px; z-index: 100;
            background: white; border-radius: 50%; width: 40px; height: 40px;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); cursor: pointer; border: none;
        }

        .booking-panel {
            position: fixed; bottom: 0; width: 100%; height: 35%;
            background: white; border-top-left-radius: 25px; border-top-right-radius: 25px;
            box-shadow: 0 -5px 15px rgba(0,0,0,0.1); padding: 20px; z-index: 1000;
        }

        .vehicle-info { display: flex; align-items: center; margin-bottom: 20px; }
        .vehicle-img { width: 60px; margin-right: 15px; }
        .details h3 { font-size: 18px; color: #333; }
        .details p { font-size: 14px; color: #777; }
        
        .price-section { margin-left: auto; text-align: right; }
        .price-section h2 { font-size: 22px; color: #000; }

        .extra-options {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px; border: 1px solid #eee; border-radius: 12px; margin-bottom: 20px;
        }
        .cash-tag { font-weight: bold; color: #2d3436; display: flex; align-items: center; gap: 5px; }

        .book-btn {
            width: 100%; background: #FCD12A; color: black; border: none;
            padding: 16px; border-radius: 12px; font-size: 18px; font-weight: bold;
            cursor: pointer; transition: 0.3s;
        }
        .book-btn:hover { background: #e3bc24; }
    </style>
</head>
<body>

    <button class="back-btn" onclick="window.history.back()">‚Üê</button>

    <div id="map"></div>

    <div class="booking-panel">
        <div class="vehicle-info">
            <img src="https://www.autoride.space/img/bike_icon.png" class="vehicle-img" alt="Bike">
            <div class="details">
                <h3>Bike <span style="font-size: 12px; font-weight: normal;">‚Ä¢ 1 Person</span></h3>
                <p id="distance-info">Calculating distance...</p>
            </div>
            <div class="price-section">
                <h2 id="fare-display">‚Çπ0</h2>
            </div>
        </div>

        <div class="extra-options">
            <div class="cash-tag">üíµ Cash</div>
            <div style="color: #666; font-size: 14px; cursor: pointer;">Offers & Coupons ></div>
        </div>

        <button class="book-btn" onclick="confirmBooking()">Book Bike</button>
    </div>

    <script src="https://maps.googleapis.com/maps/api/js?key=<%= env.GOOGLE_MAPS_API_KEY %>&libraries=geometry"></script>

    <script>
        let map, pickupMarker, dropMarker, directionsService, directionsRenderer;
        const RATE_PER_KM = 12;

        // --- Important: Fetching Dynamic Data from Server ---
        const rideData = <%- JSON.stringify(rideData) %>;

        // Dynamic Coordinates calculation
        let pickupCoords = { lat: parseFloat(rideData.pickup.lat), lng: parseFloat(rideData.pickup.lng) };
        let dropCoords = { lat: parseFloat(rideData.drop.lat), lng: parseFloat(rideData.drop.lng) };

        function initMap() {
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 14,
                center: pickupCoords,
                disableDefaultUI: true,
                styles: [{ featureType: "poi", elementType: "labels", stylers: [{ visibility: "off" }] }]
            });

            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({
                map: map,
                suppressMarkers: true,
                polylineOptions: { strokeColor: "#000", strokeWeight: 4 }
            });

            // Pickup Marker with Dynamic Data
            pickupMarker = new google.maps.Marker({
                position: pickupCoords,
                map: map,
                draggable: true,
                label: { text: "P", color: "white", fontWeight: "bold" }
            });

            // Drop Marker with Dynamic Data
            dropMarker = new google.maps.Marker({
                position: dropCoords,
                map: map,
                draggable: true,
                label: { text: "D", color: "white", fontWeight: "bold" }
            });

            calculateRoute();

            // Auto-update price when markers are dragged
            [pickupMarker, dropMarker].forEach(marker => {
                marker.addListener("dragend", () => {
                    calculateRoute();
                });
            });
        }

        function calculateRoute() {
            const start = pickupMarker.getPosition();
            const end = dropMarker.getPosition();

            directionsService.route({
                origin: start,
                destination: end,
                travelMode: 'DRIVING'
            }, (response, status) => {
                if (status === 'OK') {
                    directionsRenderer.setDirections(response);
                    const distanceInMeters = response.routes[0].legs[0].distance.value;
                    const distanceInKm = distanceInMeters / 1000;
                    
                    // Fare Calculation logic
                    let totalFare = Math.round(distanceInKm * RATE_PER_KM);
                    if (totalFare < 20) totalFare = 20; // Minimum fare

                    // Updating UI
                    document.getElementById("distance-info").innerText = distanceInKm.toFixed(1) + " km away";
                    document.getElementById("fare-display").innerText = "‚Çπ" + totalFare;
                }
            });
        }

        function confirmBooking() {
            alert("Booking request sent! Connecting to driver...");
            // Post booking logic goes here
        }

        window.onload = initMap;
    </script>
</body>
</html>