<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Passenger Booking Page</title>
    
    
    <link rel="manifest" href="/manifest.json" />
<meta name="theme-color" content="#007bff" />

<!-- Service Worker registration -->
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/sw.js')
      .then(() => {
        console.log('Service Worker registered successfully.');
      })
      .catch((err) => {
        console.error('Service Worker registration failed:', err);
      });
  }
</script>

    
    
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f8f9fa;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        .phone-container {
            width: 100%;
            max-width: 414px;
            height: 100%;
            margin: 0 auto;
            background-color: white;
            border-radius: 20px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
        }
        
        .header {
            padding: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: #4355f9;
            color: white;
        }
        
        .back-icon {
            font-size: 20px;
            cursor: pointer;
        }
        
        .header-title {
            font-weight: 500;
        }
        
        .notification-icon {
            font-size: 20px;
            cursor: pointer;
        }
        
        .map-container {
            height: 50%;
            width: 100%;
            position: relative;
        }
        
        #map {
            height: 100%;
            width: 100%;
        }
        
        .location-pins {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 10px;
        }
        
        .location-pin {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .pin-icon {
            background-color: #4355f9;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-size: 14px;
        }
        
        .pin-details {
            font-size: 12px;
        }
        
        .pin-name {
            font-weight: 500;
            margin-bottom: 2px;
        }
        
        .pin-address {
            color: #666;
        }
        
        .booking-details {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
        }
        
        .ride-options {
            display: flex;
            margin-bottom: 20px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }
        
        .ride-options::-webkit-scrollbar {
            display: none;
        }
        
        .ride-option {
            min-width: 80px;
            margin-right: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            padding: 10px;
            border-radius: 10px;
            transition: all 0.3s ease;
        }
        
        .ride-option.active {
            background-color: #f0f4ff;
        }
        
        .ride-icon {
            width: 40px;
            height: 40px;
            background-color: #eff2ff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 8px;
            font-size: 20px;
        }
        
        .ride-name {
            font-size: 12px;
            color: #333;
            font-weight: 500;
        }
        
        .location-inputs {
            margin-bottom: 20px;
        }
        
        .location-input {
            display: flex;
            align-items: center;
            padding: 12px;
            background-color: #f5f5f5;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .input-icon {
            margin-right: 10px;
            color: #4355f9;
            font-size: 18px;
        }
        
        .input-details {
            flex: 1;
        }
        
        .input-label {
            font-size: 12px;
            color: #999;
            margin-bottom: 2px;
        }
        
        .input-value {
            font-size: 14px;
            color: #333;
        }
        
        .fare-details {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .fare-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .fare-title {
            font-weight: 500;
            color: #333;
        }
        
        .fare-amount {
            font-weight: bold;
            color: #4355f9;
        }
        
        .fare-breakdown {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .book-button {
            background-color: #4355f9;
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .book-button:hover {
            background-color: #3646d9;
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            display: none;
        }
        
        .modal {
            background-color: white;
            width: 90%;
            max-width: 350px;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
        }
        
        .modal-header {
            margin-bottom: 15px;
        }
        
        .modal-title {
            font-weight: 600;
            font-size: 18px;
            color: #333;
        }
        
        .modal-body {
            margin-bottom: 20px;
        }
        
        .timer {
            font-size: 32px;
            font-weight: bold;
            color: #4355f9;
            margin: 15px 0;
        }
        
        .searching-text {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }
        
        .driver-info {
            display: flex;
            align-items: center;
            margin-top: 15px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }
        
        .driver-pic {
            width: 40px;
            height: 40px;
            background-color: #4355f9;
            border-radius: 50%;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 10px;
        }
        
        .driver-details {
            flex: 1;
            text-align: left;
        }
        
        .driver-name {
            font-weight: 500;
            margin-bottom: 2px;
        }
        
        .driver-rating {
            font-size: 12px;
            color: #ffc107;
        }
        
        .cancel-button {
            background-color: #f5f5f5;
            color: #333;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .cancel-button:hover {
            background-color: #e9e9e9;
        }
        
        .loading-dots {
            display: inline-block;
        }
        
        .loading-dots::after {
            content: '';
            animation: dots 1.5s infinite;
        }
        
        @keyframes dots {
            0% { content: ''; }
            25% { content: '.'; }
            50% { content: '..'; }
            75% { content: '...'; }
            100% { content: ''; }
        }
        
        .marker-driver {
            width: 30px;
            height: 30px;
            background-color: #4355f9;
            border-radius: 50%;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        
        .marker-passenger {
            width: 30px;
            height: 30px;
            background-color: #29b6f6;
            border-radius: 50%;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        
        .marker-destination {
            width: 30px;
            height: 30px;
            background-color: #f44336;
            border-radius: 50%;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>
<body>
    <div class="phone-container">
        <div class="header">
            <div class="back-icon">
                <i class="fas fa-arrow-left">‚Üê</i>
            </div>
            <div class="header-title">Book a Ride</div>
            <div class="notification-icon">
                <i class="fas fa-bell">üîî</i>
            </div>
        </div>
        
        <div class="map-container">
            <div id="map"></div>
            <div class="location-pins">
                <div class="location-pin">
                    <div class="pin-icon">P</div>
                    <div class="pin-details">
                        <div class="pin-name">Your Location</div>
                        <div class="pin-address" id="passenger-address">Detecting...</div>
                    </div>
                </div>
                <div class="location-pin">
                    <div class="pin-icon" style="background-color: #f44336;">D</div>
                    <div class="pin-details">
                        <div class="pin-name">Drop Location</div>
                        <div class="pin-address" id="destination-address">Tap on map to set</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="booking-details">
            <div class="ride-options">
                <div class="ride-option active" data-type="bike">
                    <div class="ride-icon">üèçÔ∏è</div>
                    <div class="ride-name">Bike</div>
                </div>
                <div class="ride-option" data-type="auto">
                    <div class="ride-icon">üõ∫</div>
                    <div class="ride-name">Auto</div>
                </div>
                <div class="ride-option" data-type="car">
                    <div class="ride-icon">üöó</div>
                    <div class="ride-name">Car</div>
                </div>
                <div class="ride-option" data-type="premium">
                    <div class="ride-icon">üöò</div>
                    <div class="ride-name">Premium</div>
                </div>
            </div>
            
            <div class="location-inputs">
                <div class="location-input">
                    <div class="input-icon">‚¨§</div>
                    <div class="input-details">
                        <div class="input-label">PICKUP</div>
                        <div class="input-value" id="pickup-value">Detecting your location...</div>
                    </div>
                </div>
                <div class="location-input">
                    <div class="input-icon" style="color: #f44336;">‚¨§</div>
                    <div class="input-details">
                        <div class="input-label">DROP</div>
                        <div class="input-value" id="drop-value">Tap on map to set destination</div>
                    </div>
                </div>
            </div>
            
            <div class="fare-details">
                <div class="fare-header">
                    <div class="fare-title">Estimated Fare</div>
                    <div class="fare-amount" id="fare-amount">‚Çπ0</div>
                </div>
                <div class="fare-breakdown" id="distance-text">Distance: 0 km</div>
                <div class="fare-breakdown">Passenger rate: ‚Çπ8/km</div>
                <div class="fare-breakdown">Driver rate: ‚Çπ12/km</div>
            </div>
            
            <div class="book-button" id="book-button">Book Ride Now</div>
        </div>
        
        <div class="modal-overlay" id="modal-overlay">
            <div class="modal">
                <div class="modal-header">
                    <div class="modal-title">Searching for Drivers</div>
                </div>
                <div class="modal-body">
                    <div class="timer" id="timer">2:00</div>
                    <div class="searching-text">
                        Looking for available drivers<span class="loading-dots"></span>
                    </div>
                    <div class="driver-info" id="driver-info" style="display: none;">
                        <div class="driver-pic">J</div>
                        <div class="driver-details">
                            <div class="driver-name">Joy</div>
                            <div class="driver-rating">‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ 3.5</div>
                        </div>
                    </div>
                </div>
                <div class="cancel-button" id="cancel-button">Cancel</div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        // Constants
        const LOCATIONIQ_API_KEY = "pk.b8d8d41e1d6dc5b30e37b1d668451f4a";
        const PASSENGER_RATE = 8; // rupees per km
        const DRIVER_RATE = 12; // rupees per km
        const BOOKING_TIMEOUT = 120; // seconds
        const DRIVER_CHECK_INTERVAL = 3000; // 3 seconds
        
        // DOM Elements
        const passengerAddress = document.getElementById('passenger-address');
        const destinationAddress = document.getElementById('destination-address');
        const pickupValue = document.getElementById('pickup-value');
        const dropValue = document.getElementById('drop-value');
        const fareAmount = document.getElementById('fare-amount');
        const distanceText = document.getElementById('distance-text');
        const bookButton = document.getElementById('book-button');
        const modalOverlay = document.getElementById('modal-overlay');
        const timerElement = document.getElementById('timer');
        const cancelButton = document.getElementById('cancel-button');
        const driverInfo = document.getElementById('driver-info');
        const rideOptions = document.querySelectorAll('.ride-option');
        
        // Variables
        let map;
        let passengerMarker;
        let destinationMarker;
        let driverMarkers = [];
        let passengerPosition = null;
        let destinationPosition = null;
        let distance = 0;
        let driverCheckInterval = null;
        let timer = null;
        let timeLeft = BOOKING_TIMEOUT;
        let selectedRideType = 'bike';
        
        // Initialize the app
        function initApp() {
            // Initialize map
            initMap();
            
            // Set up event listeners
            bookButton.addEventListener('click', startBooking);
            cancelButton.addEventListener('click', cancelBooking);
            
            // Initialize ride options
            initRideOptions();
            
            // Check for online drivers periodically
            checkOnlineDrivers();
            driverCheckInterval = setInterval(checkOnlineDrivers, DRIVER_CHECK_INTERVAL);
        }
        
        // Initialize map
        function initMap() {
            map = L.map('map').setView([20.5937, 78.9629], 5); // Default view is India
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            
            // Get passenger's location
            getPassengerLocation();
            
            // Add click event to map for setting destination
            map.on('click', setDestination);
        }
        
        // Initialize ride options
        function initRideOptions() {
            rideOptions.forEach(option => {
                option.addEventListener('click', function() {
                    // Remove active class from all options
                    rideOptions.forEach(op => op.classList.remove('active'));
                    
                    // Add active class to selected option
                    this.classList.add('active');
                    
                    // Update selected ride type
                    selectedRideType = this.dataset.type;
                    
                    // Recalculate fare if distance is available
                    if (distance > 0) {
                        calculateFare();
                    }
                });
            });
        }
        
        // Get passenger's location
        function getPassengerLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        const latitude = position.coords.latitude;
                        const longitude = position.coords.longitude;
                        
                        passengerPosition = { lat: latitude, lng: longitude };
                        
                        // Update map view
                        map.setView([latitude, longitude], 15);
                        
                        // Add passenger marker
                        addPassengerMarker(latitude, longitude);
                        
                        // Reverse geocode to get address
                        reverseGeocode(latitude, longitude, 'passenger');
                        
                        // Save passenger location to localStorage
                        savePassengerLocation(latitude, longitude);
                    },
                    error => {
                        console.error("Error getting location:", error);
                        passengerAddress.textContent = "Error: " + error.message;
                    }
                );
            } else {
                passengerAddress.textContent = "Geolocation not supported by your browser";
            }
        }
        
        // Add passenger marker
        function addPassengerMarker(latitude, longitude) {
            if (passengerMarker) {
                map.removeLayer(passengerMarker);
            }
            
            // Create a custom marker
            const markerHtml = `<div class="marker-passenger">P</div>`;
            const markerIcon = L.divIcon({
                html: markerHtml,
                className: '',
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });
            
            passengerMarker = L.marker([latitude, longitude], { icon: markerIcon }).addTo(map);
        }
        
        // Set destination
        function setDestination(e) {
            const latitude = e.latlng.lat;
            const longitude = e.latlng.lng;
            
            destinationPosition = { lat: latitude, lng: longitude };
            
            // Add or update destination marker
            addDestinationMarker(latitude, longitude);
            
            // Reverse geocode to get address
            reverseGeocode(latitude, longitude, 'destination');
            
            // Calculate distance and fare
            if (passengerPosition) {
                calculateDistance();
                calculateFare();
            }
            
            // Save destination to localStorage
            saveDestination(latitude, longitude);
        }
        
        // Add destination marker
        function addDestinationMarker(latitude, longitude) {
            if (destinationMarker) {
                map.removeLayer(destinationMarker);
            }
            
            // Create a custom marker
            const markerHtml = `<div class="marker-destination">D</div>`;
            const markerIcon = L.divIcon({
                html: markerHtml,
                className: '',
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });
            
            destinationMarker = L.marker([latitude, longitude], { icon: markerIcon }).addTo(map);
            
            // Adjust map to show both markers
            if (passengerPosition) {
                const bounds = L.latLngBounds(
                    [passengerPosition.lat, passengerPosition.lng],
                    [latitude, longitude]
                );
                map.fitBounds(bounds, { padding: [50, 50] });
            }
        }
        
        // Reverse geocode using LocationIQ
        function reverseGeocode(latitude, longitude, type) {
            const url = `https://us1.locationiq.com/v1/reverse.php?key=${LOCATIONIQ_API_KEY}&lat=${latitude}&lon=${longitude}&format=json`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data && data.display_name) {
                        const address = data.display_name;
                        
                        if (type === 'passenger') {
                            passengerAddress.textContent = address;
                            pickupValue.textContent = address;
                        } else if (type === 'destination') {
                            destinationAddress.textContent = address;
                            dropValue.textContent = address;
                        }
                    }
                })
                .catch(error => {
                    console.error("Error in reverse geocoding:", error);
                });
        }
        
        // Calculate distance between passenger and destination
        function calculateDistance() {
            if (!passengerPosition || !destinationPosition) {
                return;
            }
            
            // Haversine formula to calculate distance
            const R = 6371; // Radius of Earth in km
            const dLat = (destinationPosition.lat - passengerPosition.lat) * Math.PI / 180;
            const dLon = (destinationPosition.lng - passengerPosition.lng) * Math.PI / 180;
            
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(passengerPosition.lat * Math.PI / 180) * Math.cos(destinationPosition.lat * Math.PI / 180) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            distance = R * c;
            
            // Update distance text
            distanceText.textContent = `Distance: ${distance.toFixed(1)} km`;
        }
        
        // Calculate fare based on distance
        function calculateFare() {
            if (distance <= 0) {
                fareAmount.textContent = '‚Çπ0';
                return;
            }
            
            // Apply different rates based on ride type
            let rate = PASSENGER_RATE;
            switch (selectedRideType) {
                case 'auto':
                    rate = PASSENGER_RATE * 1.2;
                    break;
                case 'car':
                    rate = PASSENGER_RATE * 1.5;
                    break;
                case 'premium':
                    rate = PASSENGER_RATE * 2;
                    break;
            }
            
            const fare = distance * rate;
            fareAmount.textContent = `‚Çπ${fare.toFixed(1)}`;
        }
        
        // Save passenger location to localStorage
        function savePassengerLocation(latitude, longitude) {
            const locationData = {
                latitude,
                longitude,
                timestamp: new Date().toISOString()
            };
            
            localStorage.setItem('passengerLocation', JSON.stringify(locationData));
        }
        
        // Save destination to localStorage
        function saveDestination(latitude, longitude) {
            const destinationData = {
                latitude,
                longitude,
                timestamp: new Date().toISOString()
            };
            
            localStorage.setItem('destinationLocation', JSON.stringify(destinationData));
        }
        
        // Check for online drivers
        function checkOnlineDrivers() {
            // Clear existing driver markers
            driverMarkers.forEach(marker => map.removeLayer(marker));
            driverMarkers = [];
            
            // Get online drivers from localStorage
            const onlineDrivers = getOnlineDrivers();
            
            // Add markers for online drivers
            onlineDrivers.forEach(driver => {
                addDriverMarker(driver);
            });
        }
        
        // Get online drivers from localStorage
        function getOnlineDrivers() {
            // In a real app, this would be from a database or API
            // For this demo, we'll create some random online drivers
            
            // Check if driver status is set to online in localStorage
            const driverStatus = localStorage.getItem('driverStatus');
            
            if (driverStatus === 'online') {
                // Get driver location from localStorage
                const driverLocationStr = localStorage.getItem('driverLocation');
                
                if (driverLocationStr) {
                    try {
                        const driverLocation = JSON.parse(driverLocationStr);
                        
                        return [{
                            id: 'driver1',
                            name: 'Joy',
                            rating: 3.5,
                            latitude: driverLocation.latitude,
                            longitude: driverLocation.longitude
                        }];
                    } catch (e) {
                        console.error("Error parsing driver location:", e);
                    }
                }
            }
            
            // If no online drivers or error, return empty array
            return [];
        }
        
        // Add driver marker
        function addDriverMarker(driver) {
            // Create a custom marker
            const markerHtml = `<div class="marker-driver">D</div>`;
            const markerIcon = L.divIcon({
                html: markerHtml,
                className: '',
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });
            
            const marker = L.marker([driver.latitude, driver.longitude], { icon: markerIcon }).addTo(map);
            driverMarkers.push(marker);
        }
        
        // Start booking process
        function startBooking() {
            if (!passengerPosition || !destinationPosition) {
                alert("Please set pick-up and drop locations");
                return;
            }
            
            // Show modal
            modalOverlay.style.display = 'flex';
            
            // Start timer
            timeLeft = BOOKING_TIMEOUT;
            updateTimer();
            timer = setInterval(updateTimer, 1000);
            
            // Send booking request to online drivers
            sendBookingRequest();
        }
        
        // Send booking request to online drivers
        function sendBookingRequest() {
            // In a real app, this would send request to a server
            
            // For demo purposes, show driver info after a short delay
            setTimeout(() => {
                driverInfo.style.display = 'flex';
            }, 3000);
            
            // Create a booking request in localStorage
            const bookingRequest = {
                id: 'booking_' + Date.now(),
                passengerLocation: passengerPosition,
                destinationLocation: destinationPosition,
                distance: distance,
                driverRate: DRIVER_RATE * distance,
                passengerRate: PASSENGER_RATE * distance,
                rideType: selectedRideType,
                timestamp: new Date().toISOString()
            };
            
            localStorage.setItem('bookingRequest', JSON.stringify(bookingRequest));
        }
        
        // Update timer
        function updateTimer() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            
            timerElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            if (timeLeft <= 0) {
                clearInterval(timer);
                cancelBooking();
                alert("No drivers accepted your request. Please try again.");
            }
            
            timeLeft--;
        }
        
        // Cancel booking
        function cancelBooking() {
            // Hide modal
            modalOverlay.style.display = 'none';
            
            // Clear timer
            if (timer) {
                clearInterval(timer);
                timer = null;
            }
            
            // Reset driver info
            driverInfo.style.display = 'none';
            
            // Remove booking request from localStorage
            localStorage.removeItem('bookingRequest');
        }
        
        // Initialize the app when the document is loaded
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
      <% if (typeof loadingScreen !== "undefined") { %>
    <%- loadingCss %>
    <%- loadingScreen %>
    <%- loadingJs %>
    <% } %>
</body>
</html>
